## 序列标注任务中cls和sep标签

### 问题：在进行NER任务时，bert训练的结果很差，在预测时无法识别出任何的实体

```
NER

bert
2024-03-16 15:13:00,669 - __main__ - INFO - --------------------
2024-03-16 15:13:00,670 - __main__ - INFO - epoch 10 begin
2024-03-16 15:13:00,879 - __main__ - INFO - batch loss 0.420604
2024-03-16 15:13:05,442 - __main__ - INFO - batch loss 1.165826
2024-03-16 15:13:09,914 - __main__ - INFO - batch loss 2.861332
2024-03-16 15:13:09,914 - __main__ - INFO - epoch average loss: 0.586017
2024-03-16 15:13:09,914 - __main__ - INFO - 开始测试第10轮模型效果：
2024-03-16 15:13:10,949 - __main__ - INFO - PERSON类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - LOCATION类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - TIME类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - ORGANIZATION类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - Macro-F1: 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - Micro-F1 0.000000
2024-03-16 15:13:10,950 - __main__ - INFO - --------------------

lstm
2024-03-16 13:43:27,494 - __main__ - INFO - --------------------
2024-03-16 13:43:27,495 - __main__ - INFO - epoch 10 begin
2024-03-16 13:43:27,520 - __main__ - INFO - batch loss 0.003543
2024-03-16 13:43:27,820 - __main__ - INFO - batch loss 0.003461
2024-03-16 13:43:28,104 - __main__ - INFO - batch loss 0.001649
2024-03-16 13:43:28,105 - __main__ - INFO - epoch average loss: 0.003668
2024-03-16 13:43:28,105 - __main__ - INFO - 开始测试第10轮模型效果：
2024-03-16 13:43:28,180 - __main__ - INFO - PERSON类实体，准确率：0.666667, 召回率: 0.439306, F1: 0.529612
2024-03-16 13:43:28,180 - __main__ - INFO - LOCATION类实体，准确率：0.727891, 召回率: 0.557292, F1: 0.631263
2024-03-16 13:43:28,180 - __main__ - INFO - TIME类实体，准确率：0.881890, 召回率: 0.687117, F1: 0.772409
2024-03-16 13:43:28,180 - __main__ - INFO - ORGANIZATION类实体，准确率：0.576271, 召回率: 0.400000, F1: 0.472217
2024-03-16 13:43:28,180 - __main__ - INFO - Macro-F1: 0.601375
2024-03-16 13:43:28,180 - __main__ - INFO - Micro-F1 0.620750
2024-03-16 13:43:28,180 - __main__ - INFO - --------------------
```

### 分析过程

从训练日志中我们看出，bert模型训练时loss一直在震荡，预测结果正确率一直为零，但是使用LSTM进行训练模型的结果还可以

一般来说直接使用bert进行微调的效果要比LSTM好很多，没道理BERT模型做不了

1. 首先考虑的是参数设置，经过调整lr和bs均无效果

2. 接着考虑的是训练样本的问题，样本数量太少45*32（nums  *  bs）1,440条样本，是不是太少了。同样是序列标注任务，“加标点”任务的效果好很多，一轮的bert结果比5轮的lstm效果好，该任务的训练数据980*32 = 31,360条

   ```
   加标点
   
   bert
   2024-03-16 14:40:18,122 - __main__ - INFO - gpu可以使用，迁移模型至gpu
   2024-03-16 14:40:21,116 - __main__ - INFO - epoch 1 begin
   2024-03-16 14:40:21,280 - __main__ - INFO - batch loss 1.529140
   2024-03-16 14:41:38,485 - __main__ - INFO - batch loss 0.059100
   2024-03-16 14:42:57,381 - __main__ - INFO - epoch average loss: 0.084168
   2024-03-16 14:42:57,381 - __main__ - INFO - 开始测试第1轮模型效果：
   2024-03-16 14:43:07,731 - __main__ - INFO - 符号预测准确率：0.995204
   2024-03-16 14:43:07,732 - __main__ - INFO - 符号，预测准确率：0.755858
   2024-03-16 14:43:07,732 - __main__ - INFO - 符号。预测准确率：0.709097
   2024-03-16 14:43:07,732 - __main__ - INFO - 符号？预测准确率：0.626263
   2024-03-16 14:43:07,733 - __main__ - INFO - 平均acc：0.771605
   
   lstm
   2024-03-16 14:47:36,838 - __main__ - INFO - --------------------
   2024-03-16 14:47:36,839 - __main__ - INFO - epoch 5 begin
   2024-03-16 14:47:36,860 - __main__ - INFO - batch loss 0.017577
   2024-03-16 14:47:46,448 - __main__ - INFO - batch loss 0.013710
   2024-03-16 14:47:55,966 - __main__ - INFO - epoch average loss: 0.015776
   2024-03-16 14:47:55,967 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-16 14:47:57,524 - __main__ - INFO - 符号预测准确率：0.986314
   2024-03-16 14:47:57,525 - __main__ - INFO - 符号，预测准确率：0.443419
   2024-03-16 14:47:57,526 - __main__ - INFO - 符号。预测准确率：0.432733
   2024-03-16 14:47:57,526 - __main__ - INFO - 符号？预测准确率：0.393204
   2024-03-16 14:47:57,526 - __main__ - INFO - 平均acc：0.563918
   ```

但是，和参考作业对比发现，是bert中cls标签设置的不同，我是给cls标注为-1，因为cls和sep都是编码填充的，我认为它们和补齐max_len占位符是一样的；

而参考作业中是设置cls标签为“8”，即"O": 8无关标签，（但是为什么SEP不设置为8？）

于是我将cls标签改为8，训练发现模型可以进行正常的预测。

```
2024-03-15 13:47:55,789 - __main__ - INFO - --------------------
2024-03-15 13:47:55,789 - __main__ - INFO - epoch 10 begin
2024-03-15 13:47:55,948 - __main__ - INFO - batch loss 0.012286
2024-03-15 13:47:59,431 - __main__ - INFO - batch loss 0.018331
2024-03-15 13:48:02,802 - __main__ - INFO - batch loss 0.008773
2024-03-15 13:48:02,802 - __main__ - INFO - epoch average loss: 0.014361
2024-03-15 13:48:02,802 - __main__ - INFO - 开始测试第10轮模型效果：
2024-03-15 13:48:03,382 - __main__ - INFO - PERSON类实体，准确率：0.970760, 召回率: 0.959538, F1: 0.965111
2024-03-15 13:48:03,382 - __main__ - INFO - LOCATION类实体，准确率：0.900524, 召回率: 0.905263, F1: 0.902882
2024-03-15 13:48:03,382 - __main__ - INFO - TIME类实体，准确率：0.931507, 召回率: 0.834356, F1: 0.880254
2024-03-15 13:48:03,382 - __main__ - INFO - ORGANIZATION类实体，准确率：0.804348, 召回率: 0.870588, F1: 0.836153
2024-03-15 13:48:03,382 - __main__ - INFO - Macro-F1: 0.896100
2024-03-15 13:48:03,382 - __main__ - INFO - Micro-F1 0.905032
2024-03-15 13:48:03,382 - __main__ - INFO - --------------------
```



但是这是为什么？我在“加标点”任务中的cls和sep均设置为-1标签，训练都是正常的，为什么在NER任务中就不行？



于是进行实验，分别对不同任务中cls、sep以及padding的不同设置，进行实验：

1. ### “加标点”任务

   ```
   {
     "": 0,
     "，": 1,
     "。": 2,
     "？": 3
   }
   ```

   

   **cls： 0；sep： -1 ；pad ：-1**

   ```
   10000训练样本
   2024-03-15 14:21:44,445 - __main__ - INFO - epoch average loss: 0.027284
   2024-03-15 14:21:44,445 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-15 14:21:54,798 - __main__ - INFO - 符号预测准确率：0.994184
   2024-03-15 14:21:54,799 - __main__ - INFO - 符号，预测准确率：0.734677
   2024-03-15 14:21:54,799 - __main__ - INFO - 符号。预测准确率：0.753599
   2024-03-15 14:21:54,799 - __main__ - INFO - 符号？预测准确率：0.666667
   2024-03-15 14:21:54,799 - __main__ - INFO - 平均acc：0.787282
   2024-03-15 14:21:54,799 - __main__ - INFO - --------------------
   ```

   ```
   8000训练样本
   2024-03-15 14:53:02,409 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-15 14:53:03,558 - __main__ - INFO - 符号预测准确率：0.992081
   2024-03-15 14:53:03,559 - __main__ - INFO - 符号，预测准确率：0.782543
   2024-03-15 14:53:03,560 - __main__ - INFO - 符号。预测准确率：0.662093
   2024-03-15 14:53:03,561 - __main__ - INFO - 符号？预测准确率：0.687500
   2024-03-15 14:53:03,561 - __main__ - INFO - 平均acc：0.781054
   2024-03-15 14:53:03,561 - __main__ - INFO - --------------------
   ```

   

   **cls： -1； sep： -1；  pad -1**

   ```
   8000训练样本
   2024-03-15 15:08:13,830 - __main__ - INFO - epoch average loss: 0.028605
   2024-03-15 15:08:13,830 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-15 15:08:14,985 - __main__ - INFO - 符号预测准确率：0.991722
   2024-03-15 15:08:14,985 - __main__ - INFO - 符号，预测准确率：0.781791
   2024-03-15 15:08:14,985 - __main__ - INFO - 符号。预测准确率：0.670669
   2024-03-15 15:08:14,986 - __main__ - INFO - 符号？预测准确率：0.687500
   2024-03-15 15:08:14,986 - __main__ - INFO - 平均acc：0.782920
   2024-03-15 15:08:14,986 - __main__ - INFO - --------------------
   ```

   

   **cls： 0； sep： 0 ； pad： -1**

   ```
   8000训练样本
   2024-03-15 14:58:08,530 - __main__ - INFO - epoch average loss: 0.027690
   2024-03-15 14:58:08,530 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-15 14:58:09,739 - __main__ - INFO - 符号预测准确率：0.992166
   2024-03-15 14:58:09,740 - __main__ - INFO - 符号，预测准确率：0.781038
   2024-03-15 14:58:09,740 - __main__ - INFO - 符号。预测准确率：0.660377
   2024-03-15 14:58:09,741 - __main__ - INFO - 符号？预测准确率：0.687500
   2024-03-15 14:58:09,741 - __main__ - INFO - 平均acc：0.780270
   2024-03-15 14:58:09,741 - __main__ - INFO - --------------------
   ```

   

   **所有无关padding均为0**

   ```
   8000训练样本
   2024-03-15 15:02:34,788 - __main__ - INFO - epoch 5 begin
   2024-03-15 15:03:14,859 - __main__ - INFO - 开始测试第5轮模型效果：
   2024-03-15 15:03:16,018 - __main__ - INFO - 符号预测准确率：0.992563
   2024-03-15 15:03:16,018 - __main__ - INFO - 符号，预测准确率：0.778781
   2024-03-15 15:03:16,018 - __main__ - INFO - 符号。预测准确率：0.663808
   2024-03-15 15:03:16,019 - __main__ - INFO - 符号？预测准确率：0.687500
   2024-03-15 15:03:16,019 - __main__ - INFO - 平均acc：0.780663
   2024-03-15 15:03:16,019 - __main__ - INFO - --------------------
   ```

   **结论：对于“加标点”任务来说，如何给特殊符号cls和sep加标签，均无影响**

2. ### NER任务

   ```
   {
     "B-LOCATION": 0,
     "B-ORGANIZATION": 1,
     "B-PERSON": 2,
     "B-TIME": 3,
     "I-LOCATION": 4,
     "I-ORGANIZATION": 5,
     "I-PERSON": 6,
     "I-TIME": 7,
     "O": 8,
     "cls": 9,
     "sep": 10
   }
   ```

   

   **cls： 8； sep： 8； padding： -1**

   ```
   2024-03-15 15:10:21,343 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:10:21,505 - __main__ - INFO - batch loss 0.012133
   2024-03-15 15:10:25,025 - __main__ - INFO - batch loss 0.011316
   2024-03-15 15:10:28,465 - __main__ - INFO - batch loss 0.004437
   2024-03-15 15:10:28,466 - __main__ - INFO - epoch average loss: 0.014287
   2024-03-15 15:10:28,466 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:10:29,053 - __main__ - INFO - PERSON类实体，准确率：0.915254, 召回率: 0.936416, F1: 0.925709
   2024-03-15 15:10:29,053 - __main__ - INFO - LOCATION类实体，准确率：0.891192, 召回率: 0.905263, F1: 0.898167
   2024-03-15 15:10:29,054 - __main__ - INFO - TIME类实体，准确率：0.909091, 召回率: 0.858896, F1: 0.883276
   2024-03-15 15:10:29,054 - __main__ - INFO - ORGANIZATION类实体，准确率：0.802198, 召回率: 0.858823, F1: 0.829540
   2024-03-15 15:10:29,054 - __main__ - INFO - Macro-F1: 0.884173
   2024-03-15 15:10:29,054 - __main__ - INFO - Micro-F1 0.892328
   2024-03-15 15:10:29,054 - __main__ - INFO - --------------------
   ```

   

   **cls ：-1； sep： -1 ；padding： -1**，**训练失败**

   ```
   2024-03-15 15:13:44,036 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:13:44,198 - __main__ - INFO - batch loss 0.015975
   2024-03-15 15:13:47,679 - __main__ - INFO - batch loss 0.016162
   2024-03-15 15:13:51,063 - __main__ - INFO - batch loss 0.092124
   2024-03-15 15:13:51,063 - __main__ - INFO - epoch average loss: 0.014346
   2024-03-15 15:13:51,063 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:13:51,650 - __main__ - INFO - PERSON类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - LOCATION类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - TIME类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - ORGANIZATION类实体，准确率：0.000000, 召回率: 0.000000, F1: 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - Macro-F1: 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - Micro-F1 0.000000
   2024-03-15 15:13:51,650 - __main__ - INFO - --------------------
   ```

   **cls： 9； sep： 10 ；padding： 0 (新增9，10实体)**

   ```
   2024-03-15 15:42:07,488 - __main__ - INFO - --------------------
   2024-03-15 15:42:07,489 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:42:07,651 - __main__ - INFO - batch loss 0.010080
   2024-03-15 15:42:11,134 - __main__ - INFO - batch loss 0.019692
   2024-03-15 15:42:14,511 - __main__ - INFO - batch loss 0.004702
   2024-03-15 15:42:14,511 - __main__ - INFO - epoch average loss: 0.013544
   2024-03-15 15:42:14,511 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:42:15,092 - __main__ - INFO - PERSON类实体，准确率：0.937143, 召回率: 0.947977, F1: 0.942524
   2024-03-15 15:42:15,092 - __main__ - INFO - LOCATION类实体，准确率：0.905759, 召回率: 0.910526, F1: 0.908131
   2024-03-15 15:42:15,092 - __main__ - INFO - TIME类实体，准确率：0.932432, 召回率: 0.846626, F1: 0.887455
   2024-03-15 15:42:15,092 - __main__ - INFO - ORGANIZATION类实体，准确率：0.815217, 召回率: 0.882353, F1: 0.847453
   2024-03-15 15:42:15,092 - __main__ - INFO - Macro-F1: 0.896391
   2024-03-15 15:42:15,092 - __main__ - INFO - Micro-F1 0.903857
   2024-03-15 15:42:15,093 - __main__ - INFO - --------------------
   ```

   

   **cls： 8； sep： -1； padding： -1**

   ```
   2024-03-15 13:47:55,789 - __main__ - INFO - --------------------
   2024-03-15 13:47:55,789 - __main__ - INFO - epoch 10 begin
   2024-03-15 13:47:55,948 - __main__ - INFO - batch loss 0.012286
   2024-03-15 13:47:59,431 - __main__ - INFO - batch loss 0.018331
   2024-03-15 13:48:02,802 - __main__ - INFO - batch loss 0.008773
   2024-03-15 13:48:02,802 - __main__ - INFO - epoch average loss: 0.014361
   2024-03-15 13:48:02,802 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 13:48:03,382 - __main__ - INFO - PERSON类实体，准确率：0.970760, 召回率: 0.959538, F1: 0.965111
   2024-03-15 13:48:03,382 - __main__ - INFO - LOCATION类实体，准确率：0.900524, 召回率: 0.905263, F1: 0.902882
   2024-03-15 13:48:03,382 - __main__ - INFO - TIME类实体，准确率：0.931507, 召回率: 0.834356, F1: 0.880254
   2024-03-15 13:48:03,382 - __main__ - INFO - ORGANIZATION类实体，准确率：0.804348, 召回率: 0.870588, F1: 0.836153
   2024-03-15 13:48:03,382 - __main__ - INFO - Macro-F1: 0.896100
   2024-03-15 13:48:03,382 - __main__ - INFO - Micro-F1 0.905032
   2024-03-15 13:48:03,382 - __main__ - INFO - --------------------
   ```

   

   **cls：8 ；sep：8；padding： -1**

   ```
   2024-03-15 15:15:42,384 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:15:42,550 - __main__ - INFO - batch loss 0.021992
   2024-03-15 15:15:46,085 - __main__ - INFO - batch loss 0.011912
   2024-03-15 15:15:49,501 - __main__ - INFO - batch loss 0.004265
   2024-03-15 15:15:49,502 - __main__ - INFO - epoch average loss: 0.011338
   2024-03-15 15:15:49,502 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:15:50,092 - __main__ - INFO - PERSON类实体，准确率：0.959770, 召回率: 0.965318, F1: 0.962531
   2024-03-15 15:15:50,092 - __main__ - INFO - LOCATION类实体，准确率：0.889474, 召回率: 0.889474, F1: 0.889469
   2024-03-15 15:15:50,092 - __main__ - INFO - TIME类实体，准确率：0.923567, 召回率: 0.889570, F1: 0.906245
   2024-03-15 15:15:50,092 - __main__ - INFO - ORGANIZATION类实体，准确率：0.846154, 召回率: 0.905882, F1: 0.874995
   2024-03-15 15:15:50,093 - __main__ - INFO - Macro-F1: 0.908310
   2024-03-15 15:15:50,093 - __main__ - INFO - Micro-F1 0.912505
   2024-03-15 15:15:50,093 - __main__ - INFO - --------------------
   ```

   **cls：8 ；sep ：8 ； padding ：8**

   ```
   2024-03-15 15:19:19,176 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:19:19,337 - __main__ - INFO - batch loss 0.011209
   2024-03-15 15:19:22,848 - __main__ - INFO - batch loss 0.015013
   2024-03-15 15:19:26,298 - __main__ - INFO - batch loss 0.008192
   2024-03-15 15:19:26,299 - __main__ - INFO - epoch average loss: 0.012317
   2024-03-15 15:19:26,299 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:19:26,887 - __main__ - INFO - PERSON类实体，准确率：0.970760, 召回率: 0.959538, F1: 0.965111
   2024-03-15 15:19:26,887 - __main__ - INFO - LOCATION类实体，准确率：0.883838, 召回率: 0.921053, F1: 0.902057
   2024-03-15 15:19:26,887 - __main__ - INFO - TIME类实体，准确率：0.886076, 召回率: 0.858896, F1: 0.872269
   2024-03-15 15:19:26,887 - __main__ - INFO - ORGANIZATION类实体，准确率：0.793478, 召回率: 0.858823, F1: 0.824854
   2024-03-15 15:19:26,888 - __main__ - INFO - Macro-F1: 0.891073
   2024-03-15 15:19:26,888 - __main__ - INFO - Micro-F1 0.900808
   2024-03-15 15:19:26,888 - __main__ - INFO - --------------------
   ```

   

   **cls： 0； sep： -1；  padding： -1**

   ```
   2024-03-15 15:26:20,207 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:26:20,369 - __main__ - INFO - batch loss 0.043226
   2024-03-15 15:26:23,855 - __main__ - INFO - batch loss 0.036182
   2024-03-15 15:26:27,232 - __main__ - INFO - batch loss 0.014239
   2024-03-15 15:26:27,232 - __main__ - INFO - epoch average loss: 0.029766
   2024-03-15 15:26:27,233 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:26:27,818 - __main__ - INFO - PERSON类实体，准确率：0.936782, 召回率: 0.942196, F1: 0.939476
   2024-03-15 15:26:27,818 - __main__ - INFO - LOCATION类实体，准确率：0.863636, 召回率: 0.900000, F1: 0.881438
   2024-03-15 15:26:27,818 - __main__ - INFO - TIME类实体，准确率：0.903846, 召回率: 0.865031, F1: 0.884007
   2024-03-15 15:26:27,819 - __main__ - INFO - ORGANIZATION类实体，准确率：0.808989, 召回率: 0.847059, F1: 0.827581
   2024-03-15 15:26:27,819 - __main__ - INFO - Macro-F1: 0.883126
   2024-03-15 15:26:27,819 - __main__ - INFO - Micro-F1 0.890874
   2024-03-15 15:26:27,819 - __main__ - INFO - --------------------
   ```

   

   **忽略cls进行标记，全部padding为-1**

   ```
   2024-03-15 15:23:42,945 - __main__ - INFO - epoch 10 begin
   2024-03-15 15:23:43,105 - __main__ - INFO - batch loss 0.009636
   2024-03-15 15:23:46,590 - __main__ - INFO - batch loss 0.021881
   2024-03-15 15:23:49,974 - __main__ - INFO - batch loss 0.001566
   2024-03-15 15:23:49,975 - __main__ - INFO - epoch average loss: 0.017323
   2024-03-15 15:23:49,975 - __main__ - INFO - 开始测试第10轮模型效果：
   2024-03-15 15:23:50,565 - __main__ - INFO - PERSON类实体，准确率：0.932584, 召回率: 0.959538, F1: 0.945864
   2024-03-15 15:23:50,566 - __main__ - INFO - LOCATION类实体，准确率：0.886010, 召回率: 0.890625, F1: 0.888307
   2024-03-15 15:23:50,566 - __main__ - INFO - TIME类实体，准确率：0.898089, 召回率: 0.865031, F1: 0.881245
   2024-03-15 15:23:50,566 - __main__ - INFO - ORGANIZATION类实体，准确率：0.852273, 召回率: 0.882353, F1: 0.867047
   2024-03-15 15:23:50,566 - __main__ - INFO - Macro-F1: 0.895616
   2024-03-15 15:23:50,566 - __main__ - INFO - Micro-F1 0.899914
   2024-03-15 15:23:50,566 - __main__ - INFO - --------------------
   ```

   

   **结论：cls标记为-1就无法预测**

**实验结论**：同样是序列标注任务，NER的cls标记为-1，模型无法预测，但是将cls改为Other（甚至忽略cls进行标记都能有结果）就可以预测是因为什么呢?

**猜测：**模型无法理解 cls 标记 ，将 cls 标记设置为 -1 可能导致模型无法正确理解这个标记的含义，从而无法正确地将它与其他标记进行区分(很勉强的解释)



### 原因

经过老师的提醒发现序列标注任务cls标签如果标记为-1，在解码时decoder中的正则匹配就失效了

```python
    def decode(self, sentence, labels):
        sentence = "$"+sentence
        labels = "".join([str(x) for x in labels[len(sentence)+1]])
        results = defaultdict(list)
        for location in re.finditer("(04+)", labels):
            s, e = location.span()
            results["LOCATION"].append(sentence[s:e])
        for location in re.finditer("(15+)", labels):
            s, e = location.span()
            results["ORGANIZATION"].append(sentence[s:e])
        for location in re.finditer("(26+)", labels):
            s, e = location.span()
            results["PERSON"].append(sentence[s:e])
        for location in re.finditer("(37+)", labels):
            s, e = location.span()
            results["TIME"].append(sentence[s:e])
        return results
```

这里decoder采用的时将label中的元素拼接为字符串，而-1作为cls的标签时，会占据两个位置，导致true标签和pre标签的解码错位，进一步影响后面的准确率计算。

### 解决办法

将cls标记为Other，或者在使用bert模型时，移除标签的第一位

```python
    def decode(self, sentence, labels):
     #   sentence = "$"+sentence
        labels = "".join([str(x) for x in labels[1:len(sentence)+1]]) # 移除第一位
        results = defaultdict(list)
        for location in re.finditer("(04+)", labels):
            s, e = location.span()
            results["LOCATION"].append(sentence[s:e])
        for location in re.finditer("(15+)", labels):
            s, e = location.span()
            results["ORGANIZATION"].append(sentence[s:e])
        for location in re.finditer("(26+)", labels):
            s, e = location.span()
            results["PERSON"].append(sentence[s:e])
        for location in re.finditer("(37+)", labels):
            s, e = location.span()
            results["TIME"].append(sentence[s:e])
        return results
```



修改后cls的label不再影响预测结果

```
2024-03-18 13:39:25,787 - __main__ - INFO - 开始测试第10轮模型效果：
单独统计字符预测概率
*************
-1
0.0
*************
*************
8
0.99
*************
*************
2
0.85
*************
*************
6
0.86
*************
*************
1
0.59
*************
*************
5
0.77
*************
*************
3
0.73
*************
*************
7
0.86
*************
*************
0
0.8
*************
*************
4
0.8
*************
解码概率
2024-03-18 13:39:26,383 - __main__ - INFO - PERSON类实体，准确率：0.976331, 召回率: 0.953757, F1: 0.964907
2024-03-18 13:39:26,383 - __main__ - INFO - LOCATION类实体，准确率：0.874372, 召回率: 0.915789, F1: 0.894596
2024-03-18 13:39:26,383 - __main__ - INFO - TIME类实体，准确率：0.905660, 召回率: 0.883436, F1: 0.894405
2024-03-18 13:39:26,383 - __main__ - INFO - ORGANIZATION类实体，准确率：0.872093, 召回率: 0.882353, F1: 0.877188
2024-03-18 13:39:26,383 - __main__ - INFO - Macro-F1: 0.907774
2024-03-18 13:39:26,383 - __main__ - INFO - Micro-F1 0.911760
2024-03-18 13:39:26,383 - __main__ - INFO - --------------------
```





